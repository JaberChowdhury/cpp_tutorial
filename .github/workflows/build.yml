name: C/C++ Code Compilation and Release

on:
  push:
    branches:
      - main  # or any branch you want to track

jobs:
  compile:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up C++ build environment
        run: |
          if [ $RUNNER_OS == 'Windows' ]; then
            choco install mingw
          elif [ $RUNNER_OS == 'macOS' ]; then
            brew install gcc
          elif [ $RUNNER_OS == 'Linux' ]; then
            sudo apt update && sudo apt install build-essential
          fi

      - name: Compile C/C++ code
        run: |
          mkdir build
          for file in *.cpp; do
            if [ $RUNNER_OS == 'Windows' ]; then
              g++ $file -o build/$(basename $file .cpp).exe
            elif [ $RUNNER_OS == 'macOS' ] || [ $RUNNER_OS == 'Linux' ]; then
              g++ $file -o build/$(basename $file .cpp)
            fi
          done

      - name: Zip individual OS compiled files
        run: |
          mkdir release
          if [ $RUNNER_OS == 'Windows' ]; then
            zip -r release/windows_code.zip build/*.exe
          elif [ $RUNNER_OS == 'macOS' ]; then
            zip -r release/macos_code.zip build/*
          elif [ $RUNNER_OS == 'Linux' ]; then
            zip -r release/linux_code.zip build/*
          fi

  create_combined_zip:
    needs: compile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Combine all OS releases into one zip and tar file
        run: |
          mkdir combined
          cp release/windows_code.zip combined/
          cp release/macos_code.zip combined/
          cp release/linux_code.zip combined/
          zip -r combined/combined_code.zip combined/
          tar -cvf combined/combined_code.tar combined/

  release:
    needs: create_combined_zip
    runs-on: ubuntu-latest
    steps:
      - name: Upload individual OS zip files
        uses: softprops/action-gh-release@v1
        with:
          files: release/windows_code.zip,release/macos_code.zip,release/linux_code.zip

      - name: Upload combined zip and tar files
        uses: softprops/action-gh-release@v1
        with:
          files: combined/combined_code.zip,combined/combined_code.tar
